<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>VR –ù–µ–≤–∏–¥–∏–º–æ—Å—Ç—å</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;overflow:hidden;font-family:sans-serif;touch-action:none;-webkit-user-select:none;user-select:none}
video,#proc,#bg{display:none}

#intro{
  position:fixed;inset:0;z-index:200;
  background:linear-gradient(135deg,#0a0a0a,#1a1a2e,#0a0a0a);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  color:#fff;padding:20px;text-align:center;
}
#intro h1{font-size:26px;color:#0f0;margin-bottom:8px;text-shadow:0 0 20px #0f06}
#intro p{font-size:13px;color:#aaa;margin-bottom:6px;max-width:320px;line-height:1.5}
.steps{text-align:left;font-size:13px;color:#ccc;margin:12px 0;max-width:300px}
.steps div{margin-bottom:8px;display:flex;gap:8px;align-items:flex-start}
.sn{background:#0f0;color:#000;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:11px;flex-shrink:0}
#startBtn{
  margin-top:12px;padding:16px 40px;font-size:18px;font-weight:bold;
  border:2px solid #0f0;border-radius:40px;background:transparent;color:#0f0;cursor:pointer;
}
#startBtn:active{background:#0f0;color:#000}
.good{color:#0f0;font-size:12px;margin-top:10px}

#vrView{display:none;width:100vw;height:100vh}
#vrContainer{display:flex;width:100%;height:100%}
.eye{width:50%;height:100%;overflow:hidden}
.eye canvas{display:block!important;width:100%!important;height:100%!important;object-fit:cover}
#divider{position:absolute;top:0;left:50%;width:4px;height:100%;background:#000;z-index:10;transform:translateX(-50%)}

#ui{
  position:fixed;bottom:0;left:0;right:0;z-index:100;
  display:flex;justify-content:center;flex-wrap:wrap;gap:8px;padding:12px;
  background:linear-gradient(transparent,#000e);
  transition:opacity .4s;
}
#ui.hide{opacity:0;pointer-events:none}
.btn{
  padding:10px 14px;font-size:12px;font-weight:bold;
  border:1px solid #0f08;border-radius:8px;background:#000b;color:#0f0;cursor:pointer;
  white-space:nowrap;
}
.btn:active{background:#0f03}
.btn.red{border-color:#f668;color:#f66}
.btn.active{background:#0f03;border-color:#0f0}

#msg{
  position:fixed;top:12px;left:50%;transform:translateX(-50%);z-index:100;
  color:#0f0;font-size:12px;background:#000b;padding:8px 16px;border-radius:20px;
  border:1px solid #0f04;white-space:nowrap;transition:opacity .4s;pointer-events:none;
}
#msg.hide{opacity:0}
#fps{position:fixed;top:12px;right:12px;z-index:100;color:#555;font-size:10px;font-family:monospace}

#sens{
  position:fixed;bottom:70px;left:50%;transform:translateX(-50%);z-index:100;
  display:none;align-items:center;gap:8px;background:#000b;padding:8px 16px;border-radius:12px;
  border:1px solid #0f04;
}
#sens label{color:#0f0;font-size:11px}
#sens input{width:120px}
#sensVal{color:#fff;font-size:11px;min-width:30px}
</style>
</head>
<body>

<div id="intro">
  <h1>üëª VR –ù–ï–í–ò–î–ò–ú–û–°–¢–¨</h1>
  <p>–°—Ç–∏—Ä–∞–µ—Ç –ª—é–¥–µ–π –∏–∑ –∫–∞–º–µ—Ä—ã. –î–≤–∞ —ç–∫—Ä–∞–Ω–∞ –¥–ª—è VR-–æ—á–∫–æ–≤.</p>
  <div class="steps">
    <div><div class="sn">1</div><div>–ù–∞–∂–º–∏ –°–¢–ê–†–¢ ‚Äî –≤–∫–ª—é—á–∏—Ç—Å—è –∫–∞–º–µ—Ä–∞</div></div>
    <div><div class="sn">2</div><div>–ù–∞–≤–µ–¥–∏ –Ω–∞ –ø—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ ‚Üí ¬´–ó–∞–ø–æ–º–Ω–∏—Ç—å —Ñ–æ–Ω¬ª</div></div>
    <div><div class="sn">3</div><div>–õ—é–¥–∏ —Å—Ç–∞–Ω—É—Ç –Ω–µ–≤–∏–¥–∏–º—ã–º–∏!</div></div>
    <div><div class="sn">4</div><div>–ü–æ–≤–µ—Ä–Ω–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –±–æ–∫–æ–º ‚Üí –≤ VR-–æ—á–∫–∏</div></div>
  </div>
  <p class="good">‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞! –ù–∏–∫–∞–∫–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫.</p>
  <button id="startBtn">‚ö° –°–¢–ê–†–¢</button>
  <p style="color:#f66;font-size:11px;margin-top:12px">–ù–µ —Ö–æ–¥–∏ –≤ –æ—á–∫–∞—Ö! –°—Ç–æ–π –Ω–∞ –º–µ—Å—Ç–µ.</p>
</div>

<div id="vrView">
  <div id="vrContainer">
    <div class="eye"><canvas id="L"></canvas></div>
    <div id="divider"></div>
    <div class="eye"><canvas id="R"></canvas></div>
  </div>
</div>

<div id="msg" class="hide"></div>
<div id="fps"></div>

<div id="sens">
  <label>–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</label>
  <input type="range" id="sensRange" min="10" max="80" value="35">
  <span id="sensVal">35</span>
</div>

<div id="ui" class="hide">
  <button class="btn" id="bgBtn">üì∏ –ó–∞–ø–æ–º–Ω–∏—Ç—å —Ñ–æ–Ω</button>
  <button class="btn" id="togBtn">üëÅ –≠—Ñ—Ñ–µ–∫—Ç –í–ö–õ</button>
  <button class="btn" id="sensBtn">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∞</button>
  <button class="btn" id="vrBtn">ü•Ω –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω</button>
  <button class="btn red" id="rstBtn">üîÑ –°–±—Ä–æ—Å</button>
</div>

<video id="vid" playsinline autoplay muted></video>
<canvas id="proc"></canvas>
<canvas id="bg"></canvas>

<script>
const $=id=>document.getElementById(id);

function msg(t,dur){
  $('msg').classList.remove('hide');
  $('msg').textContent=t;
  if(dur)setTimeout(()=>$('msg').classList.add('hide'),dur);
}

$('startBtn').onclick=async()=>{
  $('startBtn').textContent='üì∑ –í–∫–ª—é—á–∞—é –∫–∞–º–µ—Ä—É...';
  $('startBtn').disabled=true;

  const vid=$('vid'),Lc=$('L'),Rc=$('R'),proc=$('proc'),bgC=$('bg');
  const Lx=Lc.getContext('2d'),Rx=Rc.getContext('2d');
  const px=proc.getContext('2d',{willReadFrequently:true});
  const bx=bgC.getContext('2d',{willReadFrequently:true});

  let hasBg=false,on=true,uiVis=true,lastTap=0,sensShow=false;
  let threshold=35;
  let fc=0,lt=performance.now();
  let bgData=null;

  // –ö–∞–º–µ—Ä–∞
  let stream;
  try{
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{exact:'environment'},width:{ideal:480},height:{ideal:360}},audio:false
    });
  }catch(e){
    try{
      stream=await navigator.mediaDevices.getUserMedia({
        video:{facingMode:'environment',width:{ideal:480},height:{ideal:360}},audio:false
      });
    }catch(e2){
      try{
        stream=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
      }catch(e3){
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É. –†–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø –∏ –æ–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        $('startBtn').textContent='‚ö° –°–¢–ê–†–¢';
        $('startBtn').disabled=false;
        return;
      }
    }
  }
  vid.srcObject=stream;
  await vid.play();
  await new Promise(r=>{if(vid.videoWidth)r();else vid.onloadedmetadata=r});

  const w=vid.videoWidth,h=vid.videoHeight;
  [Lc,Rc,proc,bgC].forEach(c=>{c.width=w;c.height=h});

  $('intro').style.display='none';
  $('vrView').style.display='block';
  $('ui').classList.remove('hide');
  msg('‚úÖ –ö–∞–º–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç! –ù–∞–≤–µ–¥–∏ –Ω–∞ –ø—É—Å—Ç–æ–π —Ñ–æ–Ω ‚Üí üì∏',5000);

  // –î–≤–æ–π–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ ‚Äî —Å–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å UI
  document.addEventListener('touchstart',()=>{
    const n=Date.now();
    if(n-lastTap<300){
      uiVis=!uiVis;
      $('ui').classList.toggle('hide',!uiVis);
      if(!uiVis){$('sens').style.display='none';sensShow=false}
    }
    lastTap=n;
  });

  // –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
  $('sensRange').oninput=function(){
    threshold=parseInt(this.value);
    $('sensVal').textContent=threshold;
  };

  // –ö–Ω–æ–ø–∫–∏
  $('bgBtn').onclick=()=>{
    bx.drawImage(vid,0,0,bgC.width,bgC.height);
    bgData=bx.getImageData(0,0,w,h);
    hasBg=true;
    msg('üéØ –§–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω! –õ—é–¥–∏ –∏—Å—á–µ–∑–∞—é—Ç!',4000);
  };

  $('togBtn').onclick=()=>{
    on=!on;
    $('togBtn').textContent=on?'üëÅ –≠—Ñ—Ñ–µ–∫—Ç –í–ö–õ':'üëÅ‚Äçüó® –í–´–ö–õ';
    $('togBtn').classList.toggle('active',on);
    msg(on?'üëª –ù–µ–≤–∏–¥–∏–º–æ—Å—Ç—å –í–ö–õ':'‚è∏ –í—ã–∫–ª—é—á–µ–Ω–æ',2000);
  };

  $('sensBtn').onclick=()=>{
    sensShow=!sensShow;
    $('sens').style.display=sensShow?'flex':'none';
  };

  $('vrBtn').onclick=async()=>{
    try{await document.documentElement.requestFullscreen()}catch(e){}
    try{await screen.orientation.lock('landscape')}catch(e){}
    uiVis=false;
    $('ui').classList.add('hide');
    $('sens').style.display='none';
    sensShow=false;
    $('fps').style.display='none';
    msg('ü•Ω VR —Ä–µ–∂–∏–º! 2√ó—Ç–∞–ø = –º–µ–Ω—é',3000);
  };

  $('rstBtn').onclick=()=>{
    hasBg=false;bgData=null;
    msg('üîÑ –°–±—Ä–æ—Å. –ù–∞–≤–µ–¥–∏ –Ω–∞ —Ñ–æ–Ω ‚Üí üì∏',4000);
  };

  // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª ‚Äî –≤—ã—á–∏—Ç–∞–Ω–∏–µ —Ñ–æ–Ω–∞ (—á–∏—Å—Ç—ã–π JS, –±–µ–∑ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏)
  function loop(){
    if(!vid.videoWidth){requestAnimationFrame(loop);return}

    px.drawImage(vid,0,0,w,h);

    if(hasBg&&on&&bgData){
      const frame=px.getImageData(0,0,w,h);
      const d=frame.data;
      const b=bgData.data;
      const th=threshold*threshold*3; // –ø—Ä–µ–¥–≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–π –ø–æ—Ä–æ–≥¬≤
      const len=d.length;

      // –ë—ã—Å—Ç—Ä–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –±–µ–∑ sqrt (—Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–≤–∞–¥—Ä–∞—Ç—ã)
      for(let i=0;i<len;i+=4){
        const dr=d[i]-b[i];
        const dg=d[i+1]-b[i+1];
        const db=d[i+2]-b[i+2];
        const diff2=dr*dr+dg*dg+db*db;

        if(diff2>th){
          // –ü–∏–∫—Å–µ–ª—å –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è ‚Üí –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ —Ñ–æ–Ω
          d[i]=b[i];
          d[i+1]=b[i+1];
          d[i+2]=b[i+2];
        }
      }

      px.putImageData(frame,0,0);
    }

    Lx.drawImage(proc,0,0,w,h,0,0,Lc.width,Lc.height);
    Rx.drawImage(proc,0,0,w,h,0,0,Rc.width,Rc.height);

    fc++;
    const now=performance.now();
    if(now-lt>=1000){$('fps').textContent=fc+' FPS';fc=0;lt=now}
    requestAnimationFrame(loop);
  }
  loop();
};
</script>
</body>
</html>
