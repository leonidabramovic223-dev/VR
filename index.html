<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>VR –ù–µ–≤–∏–¥–∏–º–æ—Å—Ç—å</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;overflow:hidden;font-family:sans-serif;touch-action:none;-webkit-user-select:none;user-select:none}
video{display:none}
canvas{display:none}

#intro{
  position:fixed;inset:0;z-index:200;
  background:linear-gradient(135deg,#0a0a0a,#1a1a2e,#0a0a0a);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  color:#fff;padding:20px;text-align:center;
}
#intro h1{font-size:24px;color:#0f0;margin-bottom:10px;text-shadow:0 0 20px #0f06}
#intro p{font-size:13px;color:#aaa;margin-bottom:8px;max-width:320px;line-height:1.5}
.steps{text-align:left;font-size:13px;color:#ccc;margin:15px 0;max-width:300px}
.steps div{margin-bottom:8px;display:flex;gap:8px;align-items:flex-start}
.sn{background:#0f0;color:#000;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:11px;flex-shrink:0}
#startBtn{
  margin-top:15px;padding:16px 40px;font-size:16px;font-weight:bold;
  border:2px solid #0f0;border-radius:40px;background:transparent;color:#0f0;cursor:pointer;
}
#startBtn:active{background:#0f0;color:#000}
.warn{color:#f66;font-size:11px;margin-top:12px;max-width:280px}
.https-note{color:#ff0;font-size:11px;margin-top:8px;max-width:300px;line-height:1.4}

#vrView{display:none;width:100vw;height:100vh}
#vrContainer{display:flex;width:100%;height:100%}
.eye{width:50%;height:100%;overflow:hidden}
.eye canvas{display:block!important;width:100%!important;height:100%!important;object-fit:cover}
#divider{position:absolute;top:0;left:50%;width:4px;height:100%;background:#000;z-index:10;transform:translateX(-50%)}

#ui{
  position:fixed;bottom:0;left:0;right:0;z-index:100;
  display:flex;justify-content:center;flex-wrap:wrap;gap:8px;padding:12px;
  background:linear-gradient(transparent,#000e);
  transition:opacity .4s;
}
#ui.hide{opacity:0;pointer-events:none}
.btn{
  padding:10px 14px;font-size:12px;font-weight:bold;
  border:1px solid #0f08;border-radius:8px;background:#000b;color:#0f0;cursor:pointer;
  white-space:nowrap;
}
.btn:active{background:#0f03}
.btn.red{border-color:#f668;color:#f66}

#msg{
  position:fixed;top:12px;left:50%;transform:translateX(-50%);z-index:100;
  color:#0f0;font-size:12px;background:#000b;padding:8px 16px;border-radius:20px;
  border:1px solid #0f04;white-space:nowrap;transition:opacity .4s;
}
#msg.hide{opacity:0}
#fps{position:fixed;top:12px;right:12px;z-index:100;color:#555;font-size:10px;font-family:monospace}
</style>
</head>
<body>

<div id="intro">
  <h1>üëª VR –ù–ï–í–ò–î–ò–ú–û–°–¢–¨</h1>
  <p>–ù–µ–π—Ä–æ—Å–µ—Ç—å —Å—Ç–∏—Ä–∞–µ—Ç –ª—é–¥–µ–π –∏–∑ –∫–∞–º–µ—Ä—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏. –î–≤–∞ —ç–∫—Ä–∞–Ω–∞ –¥–ª—è VR-–æ—á–∫–æ–≤.</p>
  <div class="steps">
    <div><div class="sn">1</div><div>–ù–∞–∂–º–∏ –°–¢–ê–†–¢ ‚Äî –≤–∫–ª—é—á–∏—Ç—Å—è –∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –Ω–µ–π—Ä–æ—Å–µ—Ç—å</div></div>
    <div><div class="sn">2</div><div>–ù–∞–≤–µ–¥–∏ –Ω–∞ –ø—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ (–±–µ–∑ –ª—é–¥–µ–π!) –∏ –Ω–∞–∂–º–∏ ¬´–ó–∞–ø–æ–º–Ω–∏—Ç—å —Ñ–æ–Ω¬ª</div></div>
    <div><div class="sn">3</div><div>–õ—é–¥–∏ –ø–µ—Ä–µ–¥ –∫–∞–º–µ—Ä–æ–π —Å—Ç–∞–Ω—É—Ç –Ω–µ–≤–∏–¥–∏–º—ã–º–∏!</div></div>
    <div><div class="sn">4</div><div>–ü–æ–≤–µ—Ä–Ω–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –±–æ–∫–æ–º, –≤—Å—Ç–∞–≤—å –≤ VR-–æ—á–∫–∏</div></div>
  </div>
  <p class="https-note">‚ö† –ö–∞–º–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –ø–æ HTTPS!<br>–ó–∞–≥—Ä—É–∑–∏ –Ω–∞ GitHub Pages –∏–ª–∏ –æ—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Netlify Drop.</p>
  <button id="startBtn">‚ö° –°–¢–ê–†–¢</button>
  <p class="warn">–ù–µ —Ö–æ–¥–∏ –≤ –æ—á–∫–∞—Ö! –ï—Å—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏. –°—Ç–æ–π –Ω–∞ –º–µ—Å—Ç–µ.</p>
</div>

<div id="vrView">
  <div id="vrContainer">
    <div class="eye"><canvas id="L"></canvas></div>
    <div id="divider"></div>
    <div class="eye"><canvas id="R"></canvas></div>
  </div>
</div>

<div id="msg" class="hide"></div>
<div id="fps"></div>
<div id="ui" class="hide">
  <button class="btn" id="bgBtn">üì∏ –ó–∞–ø–æ–º–Ω–∏—Ç—å —Ñ–æ–Ω</button>
  <button class="btn" id="togBtn">üëÅ –≠—Ñ—Ñ–µ–∫—Ç –í–ö–õ</button>
  <button class="btn" id="vrBtn">ü•Ω –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω</button>
  <button class="btn red" id="rstBtn">üîÑ –°–±—Ä–æ—Å —Ñ–æ–Ω–∞</button>
</div>

<video id="vid" playsinline autoplay muted></video>
<canvas id="proc"></canvas>
<canvas id="bg"></canvas>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.1/dist/body-pix.browser.umd.js"></script>
<script>
(async()=>{
  const $=id=>document.getElementById(id);
  const vid=$('vid'),Lc=$('L'),Rc=$('R'),proc=$('proc'),bgC=$('bg');
  const Lx=Lc.getContext('2d'),Rx=Rc.getContext('2d');
  const px=proc.getContext('2d',{willReadFrequently:true});
  const bx=bgC.getContext('2d',{willReadFrequently:true});

  let net=null,hasBg=false,on=true,running=false,uiVis=true,lastTap=0;
  let fc=0,lt=performance.now();

  function msg(t,dur){
    $('msg').classList.remove('hide');
    $('msg').textContent=t;
    if(dur)setTimeout(()=>$('msg').classList.add('hide'),dur);
  }

  document.addEventListener('touchstart',()=>{
    const n=Date.now();
    if(n-lastTap<300){uiVis=!uiVis;$('ui').classList.toggle('hide',!uiVis)}
    lastTap=n;
  });

  $('startBtn').onclick=async()=>{
    $('startBtn').textContent='‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
    $('startBtn').disabled=true;

    try{
      // –ó–ê–î–ù–Ø–Ø –∫–∞–º–µ—Ä–∞ (environment = —Ç–∞ —á—Ç–æ —Å–º–æ—Ç—Ä–∏—Ç –æ—Ç —Ç–µ–±—è)
      const stream=await navigator.mediaDevices.getUserMedia({
        video:{facingMode:{exact:'environment'},width:{ideal:640},height:{ideal:480}},
        audio:false
      });
      vid.srcObject=stream;
      await vid.play();
      await new Promise(r=>{if(vid.videoWidth)r();else vid.onloadedmetadata=r});

      const w=vid.videoWidth,h=vid.videoHeight;
      [Lc,Rc,proc,bgC].forEach(c=>{c.width=w;c.height=h});

      $('intro').style.display='none';
      $('vrView').style.display='block';
      $('ui').classList.remove('hide');
      msg('‚è≥ –ù–µ–π—Ä–æ—Å–µ—Ç—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');

      await tf.setBackend('webgl');
      await tf.ready();
      net=await bodyPix.load({
        architecture:'MobileNetV1',
        outputStride:16,
        multiplier:0.50,
        quantBytes:2
      });

      msg('‚úÖ –ì–æ—Ç–æ–≤–æ! –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ –ø—É—Å—Ç–æ–π —Ñ–æ–Ω ‚Üí –∂–º–∏ üì∏',6000);
      running=true;
      loop();
    }catch(e){
      // –ï—Å–ª–∏ exact environment –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º –±–µ–∑ exact
      try{
        const stream=await navigator.mediaDevices.getUserMedia({
          video:{facingMode:'environment',width:{ideal:640},height:{ideal:480}},
          audio:false
        });
        vid.srcObject=stream;
        await vid.play();
        await new Promise(r=>{if(vid.videoWidth)r();else vid.onloadedmetadata=r});

        const w=vid.videoWidth,h=vid.videoHeight;
        [Lc,Rc,proc,bgC].forEach(c=>{c.width=w;c.height=h});

        $('intro').style.display='none';
        $('vrView').style.display='block';
        $('ui').classList.remove('hide');
        msg('‚è≥ –ù–µ–π—Ä–æ—Å–µ—Ç—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');

        await tf.setBackend('webgl');
        await tf.ready();
        net=await bodyPix.load({
          architecture:'MobileNetV1',
          outputStride:16,
          multiplier:0.50,
          quantBytes:2
        });

        msg('‚úÖ –ì–æ—Ç–æ–≤–æ! –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ –ø—É—Å—Ç–æ–π —Ñ–æ–Ω ‚Üí –∂–º–∏ üì∏',6000);
        running=true;
        loop();
      }catch(e2){
        alert('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: '+e2.message+'\n\n1) –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –ø–æ HTTPS?\n2) –†–∞–∑—Ä–µ—à–∏–ª –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ?\n3) –ö–∞–º–µ—Ä–∞ –Ω–µ –∑–∞–Ω—è—Ç–∞ –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º?');
        $('startBtn').textContent='‚ö° –°–¢–ê–†–¢';
        $('startBtn').disabled=false;
      }
    }
  };

  $('bgBtn').onclick=()=>{
    bx.drawImage(vid,0,0,bgC.width,bgC.height);
    hasBg=true;
    msg('üéØ –§–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω! –õ—é–¥–∏ —Ç–µ–ø–µ—Ä—å –Ω–µ–≤–∏–¥–∏–º—ã',4000);
  };

  $('togBtn').onclick=()=>{
    on=!on;
    $('togBtn').textContent=on?'üëÅ –≠—Ñ—Ñ–µ–∫—Ç –í–ö–õ':'üëÅ‚Äçüó® –≠—Ñ—Ñ–µ–∫—Ç –í–´–ö–õ';
    msg(on?'üëª –ù–µ–≤–∏–¥–∏–º–æ—Å—Ç—å –í–ö–õ':'‚è∏ –í—ã–∫–ª—é—á–µ–Ω–æ',2000);
  };

  $('vrBtn').onclick=async()=>{
    try{await document.documentElement.requestFullscreen()}catch(e){}
    try{await screen.orientation.lock('landscape')}catch(e){}
    uiVis=false;
    $('ui').classList.add('hide');
    $('fps').style.display='none';
    msg('ü•Ω VR! –î–≤–æ–π–Ω–æ–π —Ç–∞–ø = –º–µ–Ω—é',3000);
  };

  $('rstBtn').onclick=()=>{
    hasBg=false;
    msg('üîÑ –°–±—Ä–æ—Å. –ù–∞–≤–µ–¥–∏ –Ω–∞ –ø—É—Å—Ç–æ–π —Ñ–æ–Ω ‚Üí üì∏',4000);
  };

  async function loop(){
    if(!running)return;
    const w=vid.videoWidth,h=vid.videoHeight;
    if(!w||!h){requestAnimationFrame(loop);return}

    px.drawImage(vid,0,0,w,h);

    if(net&&hasBg&&on){
      try{
        const seg=await net.segmentPerson(vid,{
          flipHorizontal:false,
          internalResolution:'low',
          segmentationThreshold:0.55,
          scoreThreshold:0.3
        });
        const frame=px.getImageData(0,0,w,h);
        const bgImg=bx.getImageData(0,0,w,h);
        const d=frame.data,b=bgImg.data,m=seg.data;

        for(let i=0,len=m.length;i<len;i++){
          if(m[i]===1){
            const p=i*4;
            d[p]=b[p];d[p+1]=b[p+1];d[p+2]=b[p+2];
          }
        }
        // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü
        for(let y=1;y<h-1;y++){
          for(let x=1;x<w-1;x++){
            const i=y*w+x;
            if(m[i]===0&&(m[i-1]===1||m[i+1]===1||m[i-w]===1||m[i+w]===1)){
              const p=i*4;
              d[p]=(d[p]+b[p])>>1;
              d[p+1]=(d[p+1]+b[p+1])>>1;
              d[p+2]=(d[p+2]+b[p+2])>>1;
            }
          }
        }
        px.putImageData(frame,0,0);
      }catch(e){}
    }

    Lx.drawImage(proc,0,0,w,h,0,0,Lc.width,Lc.height);
    Rx.drawImage(proc,0,0,w,h,0,0,Rc.width,Rc.height);

    fc++;
    const now=performance.now();
    if(now-lt>=1000){$('fps').textContent=fc+' FPS';fc=0;lt=now}
    requestAnimationFrame(loop);
  }
})();
</script>
</body>
</html>
